---
title: "P8105 Final Project: Determinants of Global Violence"
author: "My An Huynh, Jeffrey Lin, Soo Min You, Hyun Kim, Malika Top"
output: github_document
---

```{r setup, include=FALSE}
library(readxl)
library(countrycode)
library(plotly)
library(tidyverse)
```

## Motivation

Globally, violence undermines social and economic development, with its impacts 
being more pronounced in "developing" countries. Communities lacking adequate 
resources or experiencing systemic inequities are more vulnerable to various 
health challenges, including violence. Factors that influence health also play 
a role in shaping violence, which in turn affects determinants such as housing, 
education, transportation, and economic conditions. This project seeks to 
explore the factors driving serious assault, sexual violence, and intentional 
homicide worldwide from 2015 to 2023. 

We dplyr::selected this time frame because it includes significant global events, 
including the COVID-19 pandemic and various conflicts, which have greatly 
influenced patterns of violence. Also, even though there are a lot of missing 
data for year 2023, we decided to include the year because this time period 
provides insight into the contemporary factors shaping violence worldwide. 

## Related Work





## Initial Questions



(1) What are indicators of violence (which has most influence - answered by regression)?
(2) How do rates of both indicator and outcome differ by region/country?
(3) 



# Data: Source, Scraping Method & Cleaning

## Source

Since there are many determinants and indicators of violence, we chose the 
indicators and outcomes that seem most relevant and interesting in 
exploring violence from the following sources:

* United Nations Development Program (UNDP): 
  - Human Development Index
* United Nations Office of Drugs and Crime (UNODC)
  - Corruption and Economic Crime
  - Criminal Justice Personnel
  - Human Trafficking
  - Intentional Homicide
  - Violent and Sexual Crimes
* World Bank
  - Gross Domestic Product (GDP)
  - Inflation Rate (Measured by Consumer Price Index)
  - Unemployment Rate
* World Health Organization (WHO)
  - Alcohol Consumption

Intentional homicide, and violent and sexual crimes were chosen as the outcome 
variable to quantify violence. 

* Intentional homicide:
  - counting unit: number of homicide victims per 100,000 population
  - classification:
    - situational context: organized crime, interpersonal (excluding 
    familial/intimate), socio-political
    - relationship to perpetrator: intimate partner, family member, friend, 
    colleague, etc.
    - mechanism: firearm, weapon, physical force

* Violent and sexual crimes:
  - counting unit: number of individual offences per 100,000 population
  - classification of offenses:
    - rape
    - serious assault
    - kidnapping
    - sexual violence
  - NOTE: some countries used other counting unit (a series of offenses to form 
  a case, or multiple cases to form an investigation)

## Scraping Method

The datasets were downloaded from the official websites of the sources above. 
The names of the files were also changed accordingly for clarity and to avoid 
confusion. For example, the alcohol consumption data file was renamed from 
"data.csv" to "alcohol_consumption.csv".

## Data Cleaning for Regression

### Function to Tidy Datasets
```{r pivot_tidy_function}
tidy_df = function(data, variable, pivot = FALSE, average = FALSE) {
  
  if(pivot) {
    data = data |>
      pivot_longer(cols = -iso3_code,
                   names_to = "year",
                   values_to = variable) |>
      janitor::clean_names()
  }
  
  data = data |>
    mutate(year = as.numeric(year),
           iso3_code = str_replace_all(iso3_code, "^GBR.*", "GBR"),
           iso3_code = str_replace_all(iso3_code, "^IRQ.*", "IRQ"),
           country = countrycode(iso3_code, origin = "iso3c",
                                 destination = "country.name",
                                 nomatch = NA, warn = FALSE)) |> 
    drop_na(country)
  
  if(average) {
    
    if("region" %in% colnames(data)) {
      data = data |>
        group_by(country, region, year) |>
        summarize(!!variable := mean(value))
    }
    
    else {
        data = data |>
          group_by(country, year) |>
          summarize(!!variable := mean(value))
    }
    
  }
  
  return(data)
  
}
```

For the data cleaning process, we defined a function `tidy_df()`to pipe after 
importing each dataset to automatically tidy the datasets. The `countrycode()` 
function standardizes the country names of each dataset since some of the 
country names are represented inconsistently across dataset files. For example, 
South Korea was represented as "Korea (Republic of)" and "Korea, Rep." 

Moreover, for the countrycode() function, NA is returned if no matches are 
found and warnings are also suppressed by `nomatch = NA` and `warn = FALSE` 
respectively since some datasets include iso3 codes for entities that are not 
countries. For example, EUU represents the European Union; however, the 
`countrycode()` function only recognizes iso3 codes for countries and returns a 
warning, but we are interested in countries and regions. A boolean parameter 
called `pivot` was included to indicate if a dataset needs to be pivoted and 
subsequently perform `pivot_longer()`, since some datasets had years organized 
as different columns, where each column represented values for that year. 

Also, some of the datasets include rates for different categories. For example, 
the data for economic crime includes crime rates for fraud, burglary and more. 
Therefore, another boolean parameter called "average" was included to pass an 
option to group by and summarize rates across categories and genders of 
different datasets, since the exact population for these categories were not 
provided and each category presented equal importance. The datasets will then 
be merged for regression analysis. 

### Economic Determinants
```{r tidy_econ_determinants}
gdp_df = 
  read_excel(path = "data/worldbank/gdp.xls",
             sheet = "Data", skip = 3, na = "") |>
  select(iso3_code = 2, "2015":"2023") |>
  tidy_df("gdp", pivot = TRUE)

inflation_df = 
  read_excel(path = "data/worldbank/inflation_rate.xls", 
             sheet = "Data", skip = 3, na = "") |>
  select(iso3_code = 2, "2015":"2023") |>
  tidy_df("inflation_rate", pivot = TRUE)

unemployment_df =
  read_excel(path = "data/worldbank/unemployment_rate.xlsx",
             range = "A1:BP437", na = "..") |>
  rename_with(str_replace_all, pattern = " \\[.*", replacement = "") |>
  select(iso3_code = 4, "2013":"2023") |>
  tidy_df("unemployment_rate", pivot = TRUE)

human_develop_df =
  read_csv(file = "data/undp/human_development_index.csv", na = "") |>
  head(-11) |>
  rename_with(str_replace_all, pattern = "hdi_", replacement = "") |>
  select(iso3_code = 1, "2015":"2022") |>
  tidy_df("hdi", pivot = TRUE)
```

### Social Determinants
```{r import_social_determinants}
econ_crime_df = 
  read_excel(path = "data/unodc/corruption_economic_crime.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population") |>
  tidy_df("crime_rate",  average = TRUE)

personnel_df =
  read_excel(path = "data/unodc/criminal_justice_personnel.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator == "Criminal Justice Personnel", 
         sex == "Total") |>
  tidy_df("personnel_rate", average = TRUE)

trafficking_df =
  read_excel(path = "data/unodc/human_trafficking.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Detected trafficking victims",
         category == "Total", 
         sex == "Total",
         age == "Total",
         txt_value != "<5") |>
  mutate(value = str_replace_all(txt_value, ",", ""),
         value = as.numeric(value)) |>
  select(iso3_code : region, year, trafficked_victims = value) |>
  tidy_df("trafficked_victims")

alcohol_df =
  read_csv(file = "data/who/alcohol_consumption.csv", na = "") |>
  janitor::clean_names() |>
  filter(dim1 == "Both sexes") |>
  select(iso3_code = spatial_dim_value_code, 
         year = period, 
         value = fact_value_numeric) |>
  tidy_df("alcohol_consumption_rate", average = TRUE)
```

### Outcomes of Violence
```{r import_violence_outcomes}
homicide_df = 
  read_excel(path = "data/unodc/intentional_homicide.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Victims of intentional homicide",
         unit_of_measurement == "Rate per 100,000 population",
         dimension == "Total", 
         sex == "Total", 
         age == "Total") |>
  tidy_df("homicide_rate", average = TRUE)
  
violence_df = 
  read_excel(path = "data/unodc/violent_sexual_crime.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Violent offences",
         unit_of_measurement == "Rate per 100,000 population") |>
  tidy_df("violence_rate", average = TRUE)
```

The datasets for economic crimes, criminal justice personnel, homicide and 
violence provided data for both counts and rates per 100,000 people. 
Therefore, we filtered to choose rates per 100,000 people since it allows 
standardization for comparability by adjusting for differences in population 
size. The human trafficking dataset provided data for number of human 
trafficking victims, instead of trafficking rates; the dataset also included 
a category for total number of trafficking victims, so the data was filtered for 
total category and neither the `pivot` nor `average` options were set to true 
in the `tidy_df()` function.

### Merge Datasets
```{r merge_datasets}
merged_violence_df_full =
  left_join(homicide_df, violence_df) |>
  left_join(gdp_df) |>
  left_join(inflation_df) |>
  left_join(unemployment_df) |>
  left_join(human_develop_df) |>
  left_join(econ_crime_df) |>
  left_join(personnel_df) |>
  left_join(trafficking_df) |>
  left_join(alcohol_df) |>
  mutate(country = as.factor(country),
         region = as.factor(region)) |>
  filter(between(year, 2015, 2023)) |>
  relocate(iso3_code) 
merged_violence_df =
  left_join(homicide_df, violence_df) |>
  left_join(gdp_df) |>
  left_join(inflation_df) |>
  left_join(unemployment_df) |>
  left_join(human_develop_df) |>
  left_join(econ_crime_df) |>
  left_join(personnel_df) |>
  left_join(trafficking_df) |>
  left_join(alcohol_df) |>
  mutate(country = as.factor(country),
         region = as.factor(region)) |>
  filter(between(year, 2015, 2023)) |>
  relocate(iso3_code) |>
  drop_na(violence_rate, homicide_rate)

head(merged_violence_df)

write.csv(merged_violence_df, file = "./data/merged_violence.csv")
```

The final merged dataset includes `r nrow(merged_violence_df)` rows and 
`r ncol(merged_violence_df)` columns, including iso3 codes, country, region, 
year, homicide rate, average violence offence rate, gdp, inflation rate, 
unemployment rate, average crime rate, criminal justice personnel rate, total, 
human trafficking rate and alcohol consumption rate as variables. There is a 
total of `r length(unique(pull(merged_violence_df, country)))` distinct 
countries. 

After merging the datasets, country and region were converted to categorical 
variables and the dataset was filtered for the years between 2015 and 2023, 
the period of our interest for analysis. 

## Data Cleaning for Exploratory Data Analysis

For EDA, we re-imported and tidied the homicide and violence datasets, since the 
regression dataset only includes the rates averaged across category, but we are 
also interested in exploring the two outcomes by different categories and 
genders. 

## Homicide Rate
```{r}
all_homicide_df =
  read_excel(path = "data/unodc/intentional_homicide.xlsx",
               skip = 2) |>
  janitor::clean_names()
homicide_visual_df = 
    read_excel(path = "data/unodc/intentional_homicide.xlsx",
               skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator == "Victims of intentional homicide",
         category != "Total",
         sex != "Total",
         between(year, 2015, 2023)) |>
  dplyr::select(country, unit_of_measurement, region, category, sex, year, 
                homicide_rate = value)
homicide_visual_df2 = 
    read_excel(path = "data/unodc/intentional_homicide.xlsx",
               skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator == "Victims of intentional homicide",
         category != "Total",
         sex != "Total",
         between(year, 2015, 2023)) |>
  dplyr::select(country, unit_of_measurement, region, category, sex, year, 
                homicide_rate = value)

```

## Violence Rate

```{r}
### Maybe rename to `violence_victim_visual_df`
violence_visual_df = 
    read_excel(path = "data/unodc/violent_sexual_crime.xlsx",
               skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator %in% c("Victims of serious assault", 
                          "Victims of sexual violence"),
         sex != "Total",
         between(year, 2015, 2023)) |>
  select(country, indicator, unit_of_measurement, region, category, sex, 
                year, violence_rate = value)
# NOTE: violent offences is not separated by gender (ie we don't know gender of perpetrator)
violent_offences_df = 
    read_excel(path = "data/unodc/violent_sexual_crime.xlsx",
               skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator == "Violent offences",
         sex == "Total",
         between(year, 2015, 2023)) |>
  dplyr::select(country, indicator, unit_of_measurement, region, category, sex, 
                year, violence_rate = value)
# Combines category into more generalized ones
simple_violent_offences_df = 
    read_excel(path = "data/unodc/violent_sexual_crime.xlsx",
               skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator == "Violent offences",
         sex == "Total",
         between(year, 2015, 2023)) |>
  mutate(category = case_when(
                    category %in% c("Sexual violence", "Sexual violence: Other acts of sexual violence",
                                    "Sexual violence: Rape", 
                                    "Sexual violence: Sexual assault") ~ "Sexual violence",
                    category %in% c("Acts intended to induce fear or emotional distress",
                                    "Acts intended to induce fear or emotional distress: Cyber-related")
                    ~ "Acts intended to induce fear or emotional distress",
                    TRUE ~ category
  )) |> 
  dplyr::select(country, indicator, unit_of_measurement, region, category, 
                year, violence_rate = value)
```

# EDA

## Homicide
### Global Homicide Rates From 2015-2023
```{r}
merged_violence_df |> 
  plot_ly(x = ~as.factor(year), y = ~homicide_rate, color = ~country,
          type = 'scatter', mode = 'lines', colors = "viridis",
          line = list(width = 1)) |> 
  layout(title = "Homicide Rates Across Years", xaxis = list(title = "Year"),
         yaxis = list(title = "Rate (per 100,000 population)"))
```
### Homicide Trend Across Region
```{r}
homicide_visual_df |>
  group_by(region, sex, year) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = year, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_grid(~region) + 
  labs(x = "Year",
       y = "Average Homicide Rate",
       Title = "Average Homicide Rate Trend")
```

The Americas and Asia have significantly higher average homicide rate across 
years for male victims compared to the other regions. The average homicide rate 
between genders are not significant for Africa, Asia and Oceania. 

### Homicide Rate Across Category
```{r}
homicide_visual_df |>
  filter(region %in% c("Asia", "Americas")) |>
  group_by(category, sex, region) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = region,
             fill = reorder(category, avg_homicide_rate))) +
  geom_col(position = "dodge", bin = 3.0) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Region",
       y = "Average Homicide Rate",
       Title = "Average Homicide Rate Across Category", 
       fill = "Category")
```

Further exploring homicide in Americas and Asia, the Americas have higher 
homicide rates for most categories compared to Asia. Homicides of perpetrator 
to victim relationship unknown has the largest homicide rate. Homicides of 
unknown types, organized criminal groups or gangs and interpersonal homicide 
are the next three categories with the highest homicide rate in the Americas. 

On the other hand, Asia has a significantly high homicide rate in terrorist 
offences (socio-political homicide) compared to the other categories,
suggesting high casualties as a result of terrorist activities for countries in 
Asia. The other categories have a homicide rate lesser than 5 percent. 

### Homicide by Category 
```{r}
homicide_visual_df |>
  group_by(region, category, year) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = as.factor(year), fill = 
               reorder(category, avg_homicide_rate))) +
  geom_bar(stat = "identity") + 
  labs(x = "Year",
       y = "Total Homicide Rate",
       Title = "Homicide by Category",
       fill = "Category")
```

The total homicide rate is the highest in 2021, but there is a noticeable 
decrease in the rate to it's lowest point in 2022 possibly due to socio-economic 
factors or public health interventions. Homicides of unknown types and perpetrator 
to victim relationship unknown have consistently high proportions in homicide. 

For the years from 2018 to 2021, we can observe that homicides 
as a result of terrorist offences (socio-political homicide) contribute 
significantly to homicide, indicating larger numbers of terrorist activities 
in many countries or regions for those years. 



I took the average for each country over the time frame and plotted using 
the choropleth. 

## Violence
```{r}
merged_violence_df |> 
  plot_ly(x = ~as.factor(year), y = ~violence_rate, color = ~country,
          type = 'scatter', mode = 'lines', colors = "viridis",
          line = list(width = 1)) |> 
  layout(title = "Violence Rates Across Years", xaxis = list(title = "Year"),
         yaxis = list(title = "Rate (per 100,000 population)"))
```
### Global Violence Rates from 2015-2023

```{r}
merged_violence_df |>
  group_by(iso3_code, country) |>
  summarize(avg_homicide = mean(homicide_rate)) |>
  drop_na(avg_homicide) |>
  mutate(text_label = str_c("Country: ", country, 
                            "\nViolance Rate: ", avg_homicide)) |>
  plot_ly(type = 'choropleth', 
          locations = ~iso3_code, 
          z = ~avg_homicide, 
          text = ~text_label, 
          colorscale = "Viridis", 
          hovertemplate = paste("%{text}<extra></extra>")) 
```

### Average Violence Rate Across Region
```{r}
violence_visual_df |>
  group_by(region, year) |>
  summarize(avg_violence_rate = mean(violence_rate)) |>
  ggplot(aes(y = avg_violence_rate, x = as.factor(year), 
             fill = reorder(region, avg_violence_rate))) +
  geom_col(position = "dodge", bin = 3.0) + 
  labs(x = "Year",
       y = "Average Violence Rate",
       Title = "Average Violence Rate Across Region",
       fill = "Region")
```

### Average Violence Rate Across Category
```{r}
violence_visual_df |>
  group_by(indicator, category, sex) |>
  summarize(avg_violence_rate = mean(violence_rate)) |>
  ggplot(aes(y = avg_violence_rate, x = category, 
             fill = reorder(indicator, avg_violence_rate))) +
  geom_col(position = "dodge", bin = 3.0) + 
  facet_grid(~sex) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Category",
       y = "Average Violence Rate",
       Title = "Average Violence Rate Across Category",
       fill = "Type")
```

### Violence Trend by Region
```{r}
violence_visual_df |>
  filter(unit_of_measurement == "Rate per 100,000 population") |>
  group_by(region, sex, year) |>
  summarize(avg_violence_rate = mean(violence_rate)) |>
  ggplot(aes(y = avg_violence_rate, x = year, color = sex)) +
  geom_smooth(method = "loess", se = FALSE, span = 3) +
  facet_grid(~region) + 
  labs(x = "Year",
       y = "Average Violence Rate",
       Title = "Average Violence Rate Trend")
```



Similar to the homicide rate, I took the average of the reported violence rate 
for each country and plotted using choropleth. However, since there are a lot 
of missing data for violence rate, I dropped the NAs first and then took the 
average. 
### Trends in Violence Rates by Category
```{r}
offence_plot = 
  simple_violent_offences_df |> 
  group_by(category, year, country, region) |> 
  summarise(grp_mean_rate = mean(violence_rate)) |> 
  ggplot(aes(x = category, y = grp_mean_rate, fill = region)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~year, ncol=2) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
offence_plot  

```

```{r choropleth}
merged_violence_df |>
  drop_na(violence_rate) |>
  group_by(iso3_code, country) |>
  summarize(avg_violence = mean(violence_rate)) |>
  mutate(text_label = str_c("Country: ", country, 
                            "\nViolance Rate: ", avg_violence)) |>
  plot_ly(type = 'choropleth', 
          locations = ~iso3_code, 
          z = ~avg_violence, 
          text = ~text_label, 
          colorscale = "Viridis", 
          hovertemplate = paste("%{text}<extra></extra>")) 
```

## Global Prevalence of Violence 

Across the time period from 2015 to 2023, the Americas consistently exhibited 
a significantly higher homicide rate compared to other regions. The difference 
in this region is pronounced, indicating a persistent and widespread issue with 
violent crime. The homicide rate in Asia is also notable. There was a rising 
trend in homicide rate from 2015 to 2021, but was followed by a sharp decrease 
in 2022. However, it should be noted that not all countries that reported 
homicide rate also reported the violence rate. 

The drop in 2022 may imply that there was a potential shift or improvement in 
the region, but it could also mean that there are some missing data in that 
year, leading a bias or misinterpretation. 

When examining violence rates, the Americas followed a similar trend to the 
homicide rate, with rates significantly higher than the other regions. This 
trend reflects the persistent issue of violence in the region, affecting not 
only homicide rates but also broader forms of violence. 
However, Oceania presented an extreme outlier in terms of violence rates, 
surpassing even the Americas. In fact, Oceania's violence rate was nearly 

## Missing Values

Predictors. 

```{r}
merged_violence_df |> select(inflation_rate)

```



## Regression 

(IN PROGRESS)



