---
title: "P8105 Final Project: Determinants of Global Violence"
author: "My An Huynh, Jeffrey Lin, Soo Min You, Hyun Kim, Malika Top"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(countrycode)
```

## Motivation

## Initial Questions

# Data: Source, Scraping Method & Cleaning

## Source

Since there are many determinants and indicators of violence, we chose the 
indicators and outcomes that we thought were most interesting and relevant in 
exploring violence from the following sources:

* International Monetary Fund (IMF)
  - Unemployment Rate
* United Nations Development Program (UNDP): 
  - Human Development Index
* United Nations Office of Drugs and Crime (UNODC)
  - Corruption and Economic Crime
  - Criminal Justice Personnel
  - Human Trafficking
  - Intentional Homicide
  - Violent and Sexual Crimes
* World Bank
  - Gross Domestic Product (GDP)
  - Inflation Rate (Measured by Consumer Price Index)
* World Health Organization (WHO)
  - Alcohol Consumption

Intentional homicide, and violent and sexual crimes were chosen as the outcome 
variable to quantify violence. 

* Intentional homicide:
  - counting unit: individual victim of homicide
  - classification:
    - situational context: organized crime, interpersonal (excluding familial/intimate),
    socio-political
    - relationship to perpetrator: intimate partner, family member, friend, colleague, etc.
    - mechanism: firearm, weapon, physical force

* Violent and sexual crimes:
  - counting unit: number of individual offences per 100,000 population
  - classification of offenses:
    - rape
    - serious assault
    - kidnapping
    - sexual violence
  - NOTE: some countries used other counting unit (a series of offenses to form a case, or multiple cases to form an investigation)


## Scraping Method

The datasets were downloaded from the official websites of the sources above. 
The names of the files were also changed accordingly for clarity and to avoid 
confusion. For example, the alcohol consumption data file was renamed from 
"data.csv" to "alcohol_consumption.csv".

## Cleaning

### Economic Determinants
```{r tidy_econ_determinants}
gdp_df = 
  read_excel(
    path = "data/worldbank/gdp.xls",
    sheet = "Data",
    skip = 3,
    na = ""
  ) |>
  select(country = 2, "2015":"2023")

inflation_df = 
  read_excel(
    path = "data/worldbank/inflation_rate.xls",
    sheet = "Data",
    skip = 3,
    na = ""
  ) |>
  select(country = 2, "2015":"2023") 

unemployment_df =
  read_excel(
    path = "data/imf/unemployment_rate.xls",
    range = "A1:AY116",
    na = "no data"
  ) |>
  select(country = 1, "2015":"2023") 

human_develop_df =
  read_csv(
    file = "data/undp/human_development_index.csv",
    na = "") |>
  head(-11) |>
  rename_with(gsub, pattern = "^hdi_", replacement = "") |>
  select(country = 1, "2015":"2022")
```

### Function to pivot data and clean country names
```{r pivot_data}
pivot_df = function(data, name, value = "iso3c") {
  
  data |>
    pivot_longer(
      cols = -country,
      names_to = "year",
      values_to = paste(name)
    ) |>
    janitor::clean_names() |>
    mutate(year = as.numeric(year),
          country = countrycode(country, 
                                origin = value,
                                destination = "country.name",
                                nomatch = NA)) |>
    drop_na()
}

gdp_df = pivot_df(gdp_df, "gdp")
inflation_df = pivot_df(inflation_df, "inflation_rate")
human_develop_index_df = pivot_df(human_develop_df, "hdi")
unemployment_df = pivot_df(unemployment_df, "unemployment_rate", "country.name")
```

### Social Determinants
```{r tidy_social_determinants}
econ_crime_df = 
  read_excel(
    path = "data/unodc/corruption_economic_crime.xlsx",
    skip = 2
  ) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population")

justice_personnel_df =
  read_excel(
    path = "data/unodc/criminal_justice_personnel.xlsx",
    skip = 2
  ) |>
  janitor::clean_names() |>
  filter(indicator == "Criminal Justice Personnel",
         sex == "Total") |>
      filter(unit_of_measurement == "Rate per 100,000 population")

trafficking_df =
  read_excel(
    path = "data/unodc/human_trafficking.xlsx",
    skip = 2
  ) |>
  janitor::clean_names() |>
  filter(category == "Total",
         sex == "Total",
         age == "Total",
         txt_value != "<5") |>
  mutate(value = str_replace_all(txt_value, ",", ""),
         value = as.numeric(value))

alcohol_consumption_df =
  read_csv(
    file = "data/who/alcohol_consumption.csv", 
    na = ""
  ) |>
  janitor::clean_names() |>
  filter(dim1 == "Both sexes") |>
  select(iso3_code = spatial_dim_value_code, 
         year = period, value = fact_value_numeric)
```

### Function to pivot data and clean country names
```{r}
clean_country_names = function(data, rate) {
  
  data = 
    data |>
    mutate(year = as.numeric(year),
           iso3_code = str_replace_all(iso3_code, "^GBR.*", "GBR"),
           iso3_code = str_replace_all(iso3_code, "^IRQ.*", "IRQ"),
           country = countrycode(iso3_code, origin = "iso3c",
                                 destination = "country.name",
                                 nomatch = NA))

  if("region" %in% colnames(data)) {
    data |>
      group_by(country, region, year) |>
      summarize(rate = mean(value))
  }
  
  else {
    data |>
      group_by(country, year) |>
      summarize(rate = mean(value))
  }
}

econ_crime_df = clean_country_names(econ_crime_df, "avg_crime_rate")
justice_personnel_df = clean_country_names(justice_personnel_df, "avg_personnel_rate")
trafficking_df = clean_country_names(trafficking_df, "avg_trafficking_rate")
alcohol_consumption_df = clean_country_names(alcohol_consumption_df, "avg_consumption_rate")
```


### Outcomes of Violence
```{r tidy_violence_outcomes}
homicide_rate_df = 
    readxl::read_excel(
    path = "data/unodc/intentional_homicide.xlsx",
    skip = 2
  ) |>
  janitor::clean_names() |>
  filter(indicator == "Victims of intentional homicide",
         unit_of_measurement == "Rate per 100,000 population",
         dimension == "Total",
         sex == "Total",
         age == "Total")

violence_rate_df = 
    readxl::read_excel(
    path = "data/unodc/violent_sexual_crime.xlsx",
    skip = 2
  ) |>
  janitor::clean_names() |>
  filter(indicator == "Violent offences",
         unit_of_measurement == "Rate per 100,000 population")

homicide_rate_df = clean_country_names(homicide_rate_df, "avg_homicide_rate")
violence_rate_df = clean_country_names(violence_rate_df, "avg_violence_rate")
```

For the economic determinants, all the datasets had years organized as different
columns, where each column represented values for that specific year. Therefore, 
pivot_longer() was applied to pivot years and their respective values into two 
columns. 

For rates of all social determinants, we filtered and chose the data to be 
rates per 100,000 people since it allows standardization for comparability by
adjusting for differences in population size. 

The countrycode() function from the countrycode package was also implemented in 
order to standardize the country names of each dataset since some of the 
country names were represented inconsistently across datasets. For example, 
South Korea was represented as "Korea (Republic of)" and "Korea, Rep."

### Merge Datasets
```{r merge_datasets}
merged_violence_df =
  left_join(homicide_rate_df, violence_rate_df) |>
  left_join(gdp_df) |>
  left_join(inflation_df) |>
  left_join(unemployment_df) |>
  left_join(human_develop_df) |>
  left_join(econ_crime_df) |>
  left_join(justice_personnel_df) |>
  left_join(trafficking_df) |>
  left_join(alcohol_consumption_df) |>
  mutate(country = as.factor(country),
         region = as.factor(region)) |>
  filter(between(year, 2015, 2023)) |>
  drop_na(country, region)

str(merged_violence_df)
```

The final merged dataset includes `r nrow(merged_violence_df)` rows and 
`r ncol(merged_violence_df)` columns, including country, region, year, homicide 
rate, average violence offence rate, gdp, inflation rate, unemployment rate, 
average crime rate, average (criminal justice) personnel rate, total drug 
seized (2018 - 2022), total arm seized, total trafficking and alcohol 
consumption as variables. There is a total of 
`r length(unique(pull(merged_violence_df, country)))` distinct countries. 

After merging the datasets, country and region were converted to categorical 
variables. Rows with NA values for country and region were dropped, and the 
dataset was filtered for the years between 2015 and 2023. 

# EDA

## Visualization

```{r}
homicide_visual_df = 
    readxl::read_excel(
    path = "data/unodc/intentional_homicide.xlsx",
    skip = 2
  ) |>
  janitor::clean_names() |>
  filter(indicator == "Victims of intentional homicide",
         unit_of_measurement == "Rate per 100,000 population",
         category != "Total",
         sex != "Total",
         between(year, 2015, 2023)) |>
  select(country, region, category, sex, year, homicide_rate = value)
```

```{r}
homicide_visual_df |>
  group_by(region, year) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = as.factor(year), fill = region)) +
  geom_col(position = "dodge", bin = 3.0) + 
  labs(x = "Year",
       y = "Average Homicide Rate",
       Title = "Average Homicide Rate Across Region")
```
```{r}
homicide_visual_df |>
  group_by(region, sex, year) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = year, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_grid(~region) + 
  labs(x = "Year",
       y = "Average Homicide Rate",
       Title = "Average Homicide Rate Trend")
```

## Data Transformation 

## Regression 






