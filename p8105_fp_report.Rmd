---
title: "P8105 Final Project: Determinants of Global Violence"
author: "My An Huynh, Jeffrey Lin, Soo Min You, Hyun Kim, Malika Top"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(readxl)
library(countrycode)
library(plotly)
```

## Motivation


(ONE OR TWO PARAGRAPHS)


## Initial Questions


(ONE PARAGRAPH WITH LIST OF QUESTIONS)


# Data: Source, Scraping Method & Cleaning

## Source

Since there are many determinants and indicators of violence, we chose the 
indicators and outcomes that we thought were most interesting and relevant in 
exploring violence from the following sources:

* United Nations Development Program (UNDP): 
  - Human Development Index
* United Nations Office of Drugs and Crime (UNODC)
  - Corruption and Economic Crime
  - Criminal Justice Personnel
  - Human Trafficking
  - Intentional Homicide
  - Violent and Sexual Crimes
* World Bank
  - Gross Domestic Product (GDP)
  - Inflation Rate (Measured by Consumer Price Index)
  - Unemployment Rate
* World Health Organization (WHO)
  - Alcohol Consumption

Intentional homicide, and violent and sexual crimes were chosen as the outcome 
variable to quantify violence. 

* Intentional homicide:
  - counting unit: number of homicide victims per 100,000 population
  - classification:
    - situational context: organized crime, interpersonal (excluding 
    familial/intimate), socio-political
    - relationship to perpetrator: intimate partner, family member, friend, 
    colleague, etc.
    - mechanism: firearm, weapon, physical force

* Violent and sexual crimes:
  - counting unit: number of individual offences per 100,000 population
  - classification of offenses:
    - rape
    - serious assault
    - kidnapping
    - sexual violence
  - NOTE: some countries used other counting unit (a series of offenses to form 
  a case, or multiple cases to form an investigation)

## Scraping Method

The datasets were downloaded from the official websites of the sources above. 
The names of the files were also changed accordingly for clarity and to avoid 
confusion. For example, the alcohol consumption data file was renamed from 
"data.csv" to "alcohol_consumption.csv".

## Cleaning

### Function to Tidy Datasets
```{r pivot_tidy_function}
tidy_df = function(data, variable, pivot = FALSE, average = FALSE) {
  
  if(pivot) {
    data = data |>
      pivot_longer(cols = -iso3_code,
                   names_to = "year",
                   values_to = variable) |>
      janitor::clean_names()
  }
  
  data = data |>
    mutate(year = as.numeric(year),
           iso3_code = str_replace_all(iso3_code, "^GBR.*", "GBR"),
           iso3_code = str_replace_all(iso3_code, "^IRQ.*", "IRQ"),
           country = countrycode(iso3_code, origin = "iso3c",
                                 destination = "country.name",
                                 nomatch = NA, warn = FALSE)) |> 
    drop_na(country)
  
  if(average) {
    
    if("region" %in% colnames(data)) {
      data = data |>
        group_by(country, region, year) |>
        summarize(!!variable := mean(value))
    }
    
    else {
        data = data |>
          group_by(country, year) |>
          summarize(!!variable := mean(value))
    }
    
  }
  
  return(data)
  
}
```

For the data cleaning process, we defined a function `tidy_df()`to pipe after 
importing each dataset to automatically tidy the datasets. The `countrycode()` 
function standardizes the country names of each dataset since some of the 
country names are represented inconsistently across dataset files. For example, 
South Korea was represented as "Korea (Republic of)" and "Korea, Rep." 

Moreover, for the countrycode() function, NA is returned if no matches are 
found and warnings are also suppressed by `nomatch = NA` and `warn = FALSE` 
respectively since some datasets include iso3 codes for entities that are not 
countries. For example, EUU represents the European Union; however, the 
`countrycode()` function only recognizes iso3 codes for countries and returns a 
warning, but we are interested in countries and regions. A boolean parameter 
called `pivot` was included to indicate if a dataset needs to be pivoted and 
subsequently perform `pivot_longer()`, since some datasets had years organized 
as different columns, where each column represented values for that year. 

Also, some of the datasets include rates for different categories. For example, 
the data for economic crime includes crime rates for fraud, burglary and more. 
Therefore, another boolean parameter called "average" was included to pass an 
option to group by and summarize rates across categories and genders of 
different datasets, which will then be merged into a single dataset to be used 
for regression analysis of the EDA. 

### Economic Determinants
```{r tidy_econ_determinants}
gdp_df = 
  read_excel(path = "data/worldbank/gdp.xls",
             sheet = "Data", skip = 3, na = "") |>
  select(iso3_code = 2, "2015":"2023") |>
  tidy_df("gdp", pivot = TRUE)

inflation_df = 
  read_excel(path = "data/worldbank/inflation_rate.xls", 
             sheet = "Data", skip = 3, na = "") |>
  select(iso3_code = 2, "2015":"2023") |>
  tidy_df("inflation_rate", pivot = TRUE)

unemployment_df =
  read_excel(path = "data/worldbank/unemployment_rate.xlsx",
             range = "A1:BP437", na = "..") |>
  rename_with(str_replace_all, pattern = " \\[.*", replacement = "") |>
  select(iso3_code = 4, "2013":"2023") |>
  tidy_df("unemployment_rate", pivot = TRUE)

human_develop_df =
  read_csv(file = "data/undp/human_development_index.csv", na = "") |>
  head(-11) |>
  rename_with(str_replace_all, pattern = "hdi_", replacement = "") |>
  select(iso3_code = 1, "2015":"2022") |>
  tidy_df("hdi", pivot = TRUE)
```

### Social Determinants
```{r import_social_determinants}
econ_crime_df = 
  read_excel(path = "data/unodc/corruption_economic_crime.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population") |>
  tidy_df("crime_rate",  average = TRUE)

personnel_df =
  read_excel(path = "data/unodc/criminal_justice_personnel.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(unit_of_measurement == "Rate per 100,000 population",
         indicator == "Criminal Justice Personnel", 
         sex == "Total") |>
  tidy_df("personnel_rate", average = TRUE)

trafficking_df =
  read_excel(path = "data/unodc/human_trafficking.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Detected trafficking victims",
         category == "Total", 
         sex == "Total",
         age == "Total",
         txt_value != "<5") |>
  mutate(value = str_replace_all(txt_value, ",", ""),
         value = as.numeric(value)) |>
  select(iso3_code : region, year, trafficked_victims = value) |>
  tidy_df("trafficked_victims")

alcohol_df =
  read_csv(file = "data/who/alcohol_consumption.csv", na = "") |>
  janitor::clean_names() |>
  filter(dim1 == "Both sexes") |>
  select(iso3_code = spatial_dim_value_code, 
         year = period, 
         value = fact_value_numeric) |>
  tidy_df("alcohol_consumption_rate", average = TRUE)
```

### Outcomes of Violence
```{r import_violence_outcomes}
homicide_df = 
  read_excel(path = "data/unodc/intentional_homicide.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Victims of intentional homicide",
         unit_of_measurement == "Rate per 100,000 population",
         dimension == "Total", 
         sex == "Total", 
         age == "Total") |>
  tidy_df("homicide_rate", average = TRUE)
  
violence_df = 
  read_excel(path = "data/unodc/violent_sexual_crime.xlsx", skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Violent offences",
         unit_of_measurement == "Rate per 100,000 population") |>
  tidy_df("violence_rate", average = TRUE)
```

The datasets for economic crimes, criminal justice personnel, homicide and 
violence provided data for both counts and rates per 100,000 people. 
Therefore, we filtered to choose rates per 100,000 people since it allows 
standardization for comparability by adjusting for differences in population 
size. The human trafficking dataset provided data for number of human 
trafficking victims, instead of trafficking rates; the dataset also included 
a category for total number of trafficking victims, so the data was filtered for 
total category and neither the `pivot` nor `average` options were set to true 
in the `tidy_df()` function.

### Merge Datasets
```{r merge_datasets}
merged_violence_df =
  left_join(homicide_df, violence_df) |>
  left_join(gdp_df) |>
  left_join(inflation_df) |>
  left_join(unemployment_df) |>
  left_join(human_develop_df) |>
  left_join(econ_crime_df) |>
  left_join(personnel_df) |>
  left_join(trafficking_df) |>
  left_join(alcohol_df) |>
  mutate(country = as.factor(country),
         region = as.factor(region)) |>
  filter(between(year, 2015, 2023)) |>
  relocate(iso3_code)

head(merged_violence_df)
```

The final merged dataset includes `r nrow(merged_violence_df)` rows and 
`r ncol(merged_violence_df)` columns, including iso3 codes, country, region, 
year, homicide rate, average violence offence rate, gdp, inflation rate, 
unemployment rate, average crime rate, criminal justice personnel rate, total, 
human trafficking rate and alcohol consumption rate as variables. There is a 
total of `r length(unique(pull(merged_violence_df, country)))` distinct 
countries. 

After merging the datasets, country and region were converted to categorical 
variables and the dataset was filtered for the years between 2015 and 2023, 
the period of our interest for analysis. 

# EDA

## Homicide Rate
```{r}
homicide_visual_df = 
    read_excel(path = "data/unodc/intentional_homicide.xlsx",
               skip = 2) |>
  janitor::clean_names() |>
  filter(indicator == "Victims of intentional homicide",
         unit_of_measurement == "Rate per 100,000 population",
         category != "Total",
         sex != "Total",
         between(year, 2015, 2023)) |>
  select(country, region, category, sex, year, homicide_rate = value)
```

Reimport and retidy data for homicide and name it as `homicide_visual_df`

```{r}
homicide_visual_df |>
  group_by(region, year) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = as.factor(year), fill = region)) +
  geom_col(position = "dodge", bin = 3.0) + 
  labs(x = "Year",
       y = "Average Homicide Rate",
       Title = "Average Homicide Rate Across Region")
```

```{r}
homicide_visual_df |>
  group_by(region, sex, year) |>
  summarize(avg_homicide_rate = mean(homicide_rate)) |>
  ggplot(aes(y = avg_homicide_rate, x = year, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_grid(~region) + 
  labs(x = "Year",
       y = "Average Homicide Rate",
       Title = "Average Homicide Rate Trend")
```

## Violence Rate

## Global Prevalence of Violence 
```{r choropleth}
# Since there are a lot of missing data for violence rate, I dropped the NAs first and then took the average over the years that are available but I don't think this is a valid way to do it. We could choose a specific year maybe? 
merged_violence_df |>
  drop_na(violence_rate) |>
  group_by(iso3_code, country) |>
  summarize(avg_violence = mean(violence_rate)) |>
  mutate(text_label = str_c("Country: ", country, 
                            "\nViolance Rate: ", avg_violence)) |>
  plot_ly(type = 'choropleth', 
          locations = ~iso3_code, 
          z = ~avg_violence, 
          text = ~text_label, 
          colorscale = "Viridis", 
          hovertemplate = paste("%{text}<extra></extra>")) 

# For the homicide rate, I took the average from 2015-2021 for each country and plotted using the choropleth. 
merged_violence_df |>
  group_by(iso3_code, country) |>
  summarize(avg_homicide = mean(homicide_rate)) |>
  drop_na(avg_homicide) |>
  mutate(text_label = str_c("Country: ", country, 
                            "\nViolance Rate: ", avg_homicide)) |>
  plot_ly(type = 'choropleth', 
          locations = ~iso3_code, 
          z = ~avg_homicide, 
          text = ~text_label, 
          colorscale = "Viridis", 
          hovertemplate = paste("%{text}<extra></extra>")) 
```


## Regression 


(IN PROGRESS)



