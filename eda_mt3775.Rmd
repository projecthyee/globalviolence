---
title: "EDA"
author: "Malika Top"
date: "2024-11-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("GGally")
library(tidyverse)
library(dplyr)
library(readxl)
library(plotly)
library(GGally)
```

### Exploring Outcome Data Again
```{r}
violent_offences_df = 
  read_excel("data/unodc/violent_sexual_crime.xlsx", skip = 2) |> 
  janitor::clean_names() |> 
  filter(unit_of_measurement == "Rate per 100,000 population") |>
  mutate(year = as.numeric(year),
         iso3_code = str_replace_all(iso3_code, "^GBR.*", "GBR"),
         iso3_code = str_replace_all(iso3_code, "^IRQ.*", "IRQ"),
         country = countrycode(iso3_code, origin = "iso3c",
                               destination = "country.name",
                               nomatch = NA),
         country = ifelse(is.na(country) & iso3_code == "XKX", "Kosovo", country)
         ) |> 
  filter(! year %in% c(2003:2014))
        
```

```{r}
violent_offences_df |> 
  group_by(year, country, category) |> 
  mutate(rate_val = value) |> 
  summarise(count = n()) |> 
  arrange(desc(count))
```
## Visualizing violence rates by region and year

```{r}
violent_offences_df |> 
  # group_by(region, category, year) |> 
  group_by(region, year) |> 
  summarize(avg_by_region = mean(value)) |> 
  ggplot(aes(x = as.factor(year), y = avg_by_region, fill = region)) +
  geom_col(position = "dodge") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
  
```

### Plotly version so users can check regions of interest 
```{r}
violent_offences_df |> 
  group_by(region, category, year) |> 
  summarize(avg_by_region = mean(value)) |> 
  plot_ly(x = ~as.factor(year), y = ~avg_by_region, color = ~region, type = "bar") |> 
  layout(title = "Average Violence Rate by World Region from 2003-2022",
         xaxis = list(title = "Year"), yaxis = list(title = "Average Violence Rate (Cases per 100,000)"))

```
# Does a more violent country mean that... they are bad? Or their criminal justice system works better?

## What were the most common types of violent offences to occur
```{r}
offense_by_cat_freq =
  violent_offences_df |> 
  group_by(category) |> 
  summarise(category_count = n()) |> 
  arrange(desc(category_count))
```

## Which countries have the highest rates violence? Of the top 10 most requent

```{r}
violent_offences_df |> 
  group_by(country, year) |> 
  summarise(avg_by_country = mean(value)) |> 
  arrange(desc(avg_by_country))
```

### Looking more specifically on the category-level

```{r}
violent_offences_df |> 
  group_by(category, country, year) |>
  summarise(avg_rate_by_cat = mean(value)) |> 
  arrange(desc(avg_rate_by_cat))
```


```{r}
merged_violence_df |> 
  select(homicide_rate,violence_rate) |> 
  ggpairs()

ggpairs(merged_violence_df, columns = 5:15)
```

```{r}
merged_violence_df |>
  group_by(iso3_code, country) |>
  summarize(avg_violence = mean(violence_rate)) |>
  drop_na(avg_violence) |>
  mutate(text_label = str_c("Country: ", country, 
                            "\nViolence Rate: ", avg_violence)) |>
  plot_ly(type = 'choropleth', 
          locations = ~iso3_code, 
          z = ~avg_violence, 
          text = ~text_label, 
          colorscale = "Viridis", 
          hovertemplate = paste("%{text}<extra></extra>")) 
```

















